name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # 允许手动触发

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: 🚀 Deploy to production server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            cd ${{ secrets.PROJECT_PATH || '~/magic-conch' }}

            echo "📦 拉取最新代码..."
            git fetch origin
            git reset --hard origin/main

            echo "🔧 检查并激活 Conda 环境..."
            if command -v conda &> /dev/null; then
              eval "$(conda shell.bash hook)"
              conda activate base || true
            fi

            echo "📦 更新依赖..."
            python -m pip install -i https://pypi.tuna.tsinghua.edu.cn/simple -r server/requirements.txt --quiet

            echo "🗄️ 运行数据库迁移..."
            python scripts/init_db.py

            echo "🔄 重启服务..."
            if sudo systemctl is-active --quiet magic-conch; then
              echo "   检测到 systemd 服务，重启中..."
              sudo systemctl restart magic-conch
              sleep 2
              if sudo systemctl is-active --quiet magic-conch; then
                echo "✅ 服务重启成功"
              else
                echo "❌ 服务重启失败，查看日志："
                sudo journalctl -u magic-conch -n 20 --no-pager
                exit 1
              fi
            else
              echo "⚠️  未检测到 systemd 服务"
              echo "   请手动重启应用"
            fi

            echo ""
            echo "🎉 部署完成！"
            echo "📊 服务状态："
            sudo systemctl status magic-conch --no-pager || echo "请检查服务状态"
