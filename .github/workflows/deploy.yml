name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ Deploy to production server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            cd ${{ secrets.PROJECT_PATH || '~/magic-conch' }}

            echo "ğŸ“¦ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin
            git reset --hard origin/main

            echo "ğŸ”§ æ£€æŸ¥å¹¶æ¿€æ´» Conda ç¯å¢ƒ..."
            if command -v conda &> /dev/null; then
              eval "$(conda shell.bash hook)"
              conda activate base || true
            fi

            echo "ğŸ“¦ æ›´æ–°ä¾èµ–..."
            python -m pip install -i https://pypi.tuna.tsinghua.edu.cn/simple -r server/requirements.txt --quiet

            echo "ğŸ—„ï¸ è¿è¡Œæ•°æ®åº“è¿ç§»..."
            python scripts/init_db.py

            echo "ğŸ”„ é‡å¯æœåŠ¡..."
            if sudo systemctl is-active --quiet magic-conch; then
              echo "   æ£€æµ‹åˆ° systemd æœåŠ¡ï¼Œé‡å¯ä¸­..."
              sudo systemctl restart magic-conch
              sleep 2
              if sudo systemctl is-active --quiet magic-conch; then
                echo "âœ… æœåŠ¡é‡å¯æˆåŠŸ"
              else
                echo "âŒ æœåŠ¡é‡å¯å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
                sudo journalctl -u magic-conch -n 20 --no-pager
                exit 1
              fi
            else
              echo "âš ï¸  æœªæ£€æµ‹åˆ° systemd æœåŠ¡"
              echo "   è¯·æ‰‹åŠ¨é‡å¯åº”ç”¨"
            fi

            echo ""
            echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
            echo "ğŸ“Š æœåŠ¡çŠ¶æ€ï¼š"
            sudo systemctl status magic-conch --no-pager || echo "è¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€"
